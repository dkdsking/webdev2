<!DOCTYPE html>
<html>
<head>
  <title>3 Screen App </title>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script defer src="https://code.getmdl.io/1.1.1/material.min.js"></script>
  <link rel="stylesheet" href="https://cdn.rawgit.com/CreativeIT/getmdl-select/master/getmdl-select.min.css">
  <script defer src="https://cdn.rawgit.com/CreativeIT/getmdl-select/master/getmdl-select.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Roboto", sans-serif;
    }
    @media screen and (max-width: 951px) {
      .raisedMargin {
        margin-bottom: 2%;
        display: block;
      }
    }
    @media screen and (max-width: 420px) {
      .centeredText {
        text-align: center;
      }
      .centeredDiv {
        margin-left: auto;
        margin-right: auto;
        width: 70%;
      }
      .centeredDiv1 {
        margin-left: auto;
        margin-right: auto;
        width: 100%;
      }
      .mobileContent {
        text-indent: -9999px;
        line-height: 0;
        /* Collapse the original line */
        ;
      }
      .mobileContent::after {
        content: "CTA Bus Arrival Times";
        text-indent: 0;
        display: block;
        line-height: initial;
        /* New content takes up original line height */
      }
      .customizeRoute, .customizeRoute1 {
        font-size: 20px;
        line-height: 150%;
        margin: 0 auto;
        text-align: center;
      }
    }
    @media screen and (max-width: 320px) {
      .tinyText {
        text-indent: -9999px;
        line-height: 0;
        /* Collapse the original line */
        ;
      }
      .tinyText::after {
        content: "Western/Addison Bus Tracker";
        text-indent: 0;
        display: block;
        line-height: initial;
        /* New content takes up original line height */
      }
    }
    .screen {
      padding-left: 2%;
      width: 96%;
    }
    .boldText {
      font-weight: bold;
    }
    .blueHr {
      background-color: rgb(63, 81, 181);
      border-top: 3px double rgb(63, 81, 181)
    }
    .invisible {
      display: none;
    }
    .addedBus {
      display: block;
      margin-top: 0.5%;
    }
    .bold {
      font-weight: bold;
    }
  </style>
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>

<body>
  <!-- Always shows a header, even in smaller screens. -->
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">
        <!-- Title -->
        <span class="mdl-layout-title">CTA Bus Tracker</span>
        <!-- Add spacer, to align navigation to the right -->
        <div class="mdl-layout-spacer"></div>
        <!-- Navigation. We hide it in small screens. -->
        <nav class="mdl-navigation mdl-layout--large-screen-only">
          <a class="mdl-navigation__link" href="#" id="topLink1">Home</a>
          <a class="mdl-navigation__link" href="#" id="topLink2">Bus Tracker</a>
          <a class="mdl-navigation__link" href="#" id="topLink3">Customize (N+E bound)</a>
          <a class="mdl-navigation__link" href="#" id="topLink4">Customize (S+W bound)</a>
        </nav>
      </div>
    </header>
    <div class="mdl-layout__drawer">
      <span class="mdl-layout-title">CTA Bus Tracker</span>
      <nav class="mdl-navigation">
        <a id="link1" class="mdl-navigation__link" href="#">Home</a>
        <a id="link2" class="mdl-navigation__link" href="#">Bus Tracker</a>
        <a id="link3" class="mdl-navigation__link" href="#">Customize (N+E bound)</a>
        <a id="link4" class="mdl-navigation__link" href="#">Customize (S+W bound)</a>
      </nav>
    </div>
    <main class="mdl-layout__content">
      <div class="screen page-content" id="screen1">
        <h3 class="centeredText tinyText">Western and Addison Bus Tracker</h3>
        <h4>Hey, Lane Tech students! Do you ride a Western or Addison bus to commute? If so, click the "Bus Tracker" link above to get real-time bus arrival predictions for your stop.</h4>
        <h4>If you want arrival times for other stops, you can use the "Customize" tabs to create your own bus trackers!</h4>      
      </div>
      <div class="screen page-content" id="screen2">
        <h3 class="centeredText mobileContent">Get the CTA Bus Arrival Times</h3>
        <h4>Click a button below to display the bus arrival predictions for that route.
          <br>Note: These four buttons are for the four Western/Addison intersection stops.</h4>
        
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv trackerPrim" id="8417">
        Northbound 49/X49 Western
      </button>
          <!-- Colored raised button -->
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv trackerPrim" id="8195">
        Southbound 49/X49 Western
      </button>
          <!-- Colored raised button -->
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv trackerPrim1" id="12527">
          Eastbound 152 Addison  
      </button>
          <!-- Colored raised button -->
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv trackerPrim1" id="12569">
          Westbound 152 Addison  
      </button>
      <div id="buttons">
      <hr><h4>Customized Stops</h4>
      </div>
      <hr>
      <div id="results"></div>
      </div>
      <div class="screen page-content" id="screen3">
        <h3 class="centeredText">Customize (North + East bound)</h3>
        <h4>Step 1: Click one of the routes below to create your own bus tracker button.
        <br> Step 2: Select one of the stop IDs and click "Add". <br> Step 3: Check the "Bus Tracker" page to see if your tracker is there. 
        The new tracker should be saved even when you refresh the page.
        <br><span class = "bold">Note: Use these routes to create trackers for North and East bound bus routes.<span></span></h4>
        
      </div>
      <div class="screen page-content" id="screen4">
        <h3 class="centeredText">Customize (South + West bound)</h3>
        <h4>Step 1: Click one of the routes below to create your own bus tracker button.
        <br> Step 2: Select one of the stop IDs and click "Add". <br> Step 3: Check the "Bus Tracker" page to see if your tracker is there. 
        The new tracker should be saved even when you refresh the page.
        <br><span class = "bold">Note: Use these routes to create trackers for South and West bound bus routes.</span></h4>
      </div>
    </main>
  </div>
  <script>
    $(document).ready(function() {
      $(".screen").hide();
      $("#screen1").show();
    })
    $("#link1").on("click", function() {
      $(".screen").hide();
      $("#screen1").show();
    })
    $("#topLink1").on("click", function() {
      $(".screen").hide();
      $("#screen1").show();
    })
    $("#link2").on("click", function() {
      $(".screen").hide();
      $("#screen2").show();
    })
    $("#topLink2").on("click", function() {
      $(".screen").hide();
      $("#screen2").show();
    })
    $("#link3").on("click", function() {
      $(".screen").hide();
      $("#screen3").show();
    })
    $("#topLink3").on("click", function() {
      $(".screen").hide();
      $("#screen3").show();
    })
    $("#link4").on("click", function() {
      $(".screen").hide();
      $("#screen4").show();
    })
    $("#topLink4").on("click", function() {
      $(".screen").hide();
      $("#screen4").show();
    })
    var db = new Dexie("ctaDB");
    db.version(1).stores({
      stops: 'name,stopid,rtnm, rtdir'
    });
    $(function() {
      var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
      var apiEndpoint = "http://ctabustracker.com/bustime/api/v2/getroutes";
      $.ajax({
        url: apiPassThruUrl,
        dataType: "json",
        method: 'GET',
        data: {
          "apiEndpoint": apiEndpoint,
          "key": "YubEefJ33AeRRyxbmYBbgN2QH",
          "format": "json"
        }
      }).done(function(data) {
        console.log(data);
        $.each(data["bustime-response"]["routes"], function(i, v) {
          var routeNum = v.rt;
          var html = "<a href = '#' class='customizeRoute' id='" + routeNum + "'>" + v.rtnm + "</a>" + "<br>";
          $("#screen3").append(html);
          var htmlAlt = "<a href = '#' class='customizeRoute1' id='" + routeNum + "alt" + "'>" + v.rtnm + "</a>" + "<br>";
          $("#screen4").append(htmlAlt);
        })
        $(".customizeRoute").click(function() {
          var id = this.id;
          var text = $(this).text();
          console.log(text);
          var html2 = "<div id='input'>" + "<br>" + "<div class='mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height' id='stopid'>" +
            "<input class='mdl-textfield__input' type='text' id='sample1' value='--Select an ID below--' readonly tabIndex='-1' >" +
            "<label for='sample1'>" +
            "<i class='mdl-icon-toggle__label material-icons'>keyboard_arrow_down</i>" +
            "</label>" +
            "<label for='sample1' class='mdl-textfield__label'>Stop IDs...</label>" +
            "<ul for='sample1' class='mdl-menu mdl-menu--bottom-left mdl-js-menu' id='stopID'>" +
            //stop ids here
            "</ul>" +
            "</div>" + "<br>" + "<button class='mdl-button mdl-js-button mdl-button--raised mdl-button--colored' id='addStop'>Add</button>" + "<br>" +
            "</div>";
          if ($("#input").length > 0) {
            $("#input").remove();
          }
          else {
            $(html2).insertAfter("#" + id);
            $(function() {
              var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
              var apiEndpoint = "http://ctabustracker.com/bustime/api/v2/getdirections";
              $.ajax({
                url: apiPassThruUrl,
                dataType: "json",
                method: 'GET',
                data: {
                  "apiEndpoint": apiEndpoint,
                  "key": "YubEefJ33AeRRyxbmYBbgN2QH",
                  "rt": id,
                  "format": "json"
                }
              }).done(function(data) {
                var direction = data["bustime-response"]["directions"]["0"]["dir"];
                var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
                var apiEndpoint = "http://ctabustracker.com/bustime/api/v2/getstops";
                $.ajax({
                  url: apiPassThruUrl,
                  dataType: "json",
                  method: 'GET',
                  data: {
                    "apiEndpoint": apiEndpoint,
                    "key": "YubEefJ33AeRRyxbmYBbgN2QH",
                    "rt": id,
                    "dir": direction,
                    "format": "json"
                  }
                }).done(function(data) {
                  console.log(data)
                  $.each(data["bustime-response"]["stops"], function(index, value) {
                    var html3 = "<li class='mdl-menu__item' value='" + value.stpnm + "'>" + value.stpnm + " (Stop ID: " + value.stpid + ")" + "</li>";
                    $("#stopID").append(html3);
                  })
                  getmdlSelect.init(".getmdl-select")
                  $("#addStop").click(function() {
                    var id = $("#sample1").val();
                    var id2 = id.split("ID: ")[1];
                    var realid = id2.substring(0, id2.length-1);
                    var stpnm = id.substring(0, id.length - 16);
                    db.stops.add({
                      name: realid,
                      stopid: stpnm,
                      rtnm: text,
                      rtdir: direction
                    })
                    var button = "<button class='mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv1 addedBus trackerPrim1' id=" +
                                  realid + ">" +
                                  text + " - " + stpnm + " (" + direction + ")" +
                                  "</button>";
                    $("#buttons").append(button);
                    $("#" + realid).click(function() {
                      $("#results").empty();
                      var id = this.id;
                      var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
                      var apiEndpoint = "http://www.ctabustracker.com/bustime/api/v2/getpredictions";
                      $.ajax({
                        url: apiPassThruUrl,
                        dataType: "json",
                        method: 'GET',
                        data: {
                          "apiEndpoint": apiEndpoint,
                          "key": "YubEefJ33AeRRyxbmYBbgN2QH",
                          "format": "json",
                          "stpid": id
                        }
                      }).done(function(data) {
                        console.log(data);
                        if (data["bustime-response"]["error"] !== undefined) {
                          $("#results").append("Sorry, no information was found. There may be no buses scheduled in the near future for this route. CTA's fault, not mine.");
                        } else {
                          $("#results").append("<h4>Bus Predictions</h4>" + "<p class='boldText'> Stop name: " + data["bustime-response"]["prd"][0].stpnm + "</p>" +
                            "<p class='boldText'>Route direction: " + data["bustime-response"]["prd"][0].rtdir + "</p>" + "<hr class='blueHr'>");
                          $.each(data["bustime-response"]["prd"], function(index, value) {
                            var prediction = value.prdctdn;
                            if (prediction !== "DLY" && prediction !== "DUE") {
                              minuteString = " MINUTES";
                              var predictionNum = prediction.toString();
                              var prediction = prediction.concat(minuteString);
                            }
                            var html = "<h6 class='boldText'>" + "Bus Arrival Time: " + prediction + "<h6>" +
                              "<hr>";
                            $("#results").append(html);
                          });
                        }
                      });
                    });
                  })
                })
              })
            });
          }
        })
        $(".customizeRoute1").click(function() {
          var id = this.id;
          var text = $(this).text();
          console.log(text);
          var html2 = "<div id='input1'>" + "<br>" + "<div class='mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height' id='stopid'>" +
            "<input class='mdl-textfield__input' type='text' id='sample1' value='--Select an ID below--' readonly tabIndex='-1' >" +
            "<label for='sample1'>" +
            "<i class='mdl-icon-toggle__label material-icons'>keyboard_arrow_down</i>" +
            "</label>" +
            "<label for='sample1' class='mdl-textfield__label'>Stop IDs...</label>" +
            "<ul for='sample1' class='mdl-menu mdl-menu--bottom-left mdl-js-menu' id='stopID'>" +
            //stop ids here
            "</ul>" +
            "</div>" + "<br>" + "<button class='mdl-button mdl-js-button mdl-button--raised mdl-button--colored' id='addStop'>Add</button>" + "<br>" +
            "</div>";
          if ($("#input1").length > 0) {
            $("#input1").remove();
          }
          else {
            var stopidSW = id.substring(0, id.length - 3);
            $(html2).insertAfter("#" + id);
            $(function() {
              var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
              var apiEndpoint = "http://ctabustracker.com/bustime/api/v2/getdirections";
              $.ajax({
                url: apiPassThruUrl,
                dataType: "json",
                method: 'GET',
                data: {
                  "apiEndpoint": apiEndpoint,
                  "key": "YubEefJ33AeRRyxbmYBbgN2QH",
                  "rt": stopidSW,
                  "format": "json"
                }
              }).done(function(data) {
                console.log(data);
                var direction = data["bustime-response"]["directions"]["1"]["dir"];
                var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
                var apiEndpoint = "http://ctabustracker.com/bustime/api/v2/getstops";
                $.ajax({
                  url: apiPassThruUrl,
                  dataType: "json",
                  method: 'GET',
                  data: {
                    "apiEndpoint": apiEndpoint,
                    "key": "YubEefJ33AeRRyxbmYBbgN2QH",
                    "rt": stopidSW,
                    "dir": direction,
                    "format": "json"
                  }
                }).done(function(data) {
                  console.log(data)
                  $.each(data["bustime-response"]["stops"], function(index, value) {
                    var html3 = "<li class='mdl-menu__item' value='" + value.stpnm + "'>" + value.stpnm + " (Stop ID: " + value.stpid + ")" + "</li>";
                    $("#stopID").append(html3);
                  })
                  getmdlSelect.init(".getmdl-select")
                  $("#addStop").click(function() {
                    var id = $("#sample1").val();
                    var id2 = id.split("ID: ")[1];
                    var realid = id2.substring(0, id2.length-1);
                    var stpnm = id.substring(0, id.length - 16);
                    console.log(realid);
                    db.stops.add({
                      name: realid,
                      stopid: stpnm,
                      rtnm: text,
                      rtdir: direction
                    })
                    var button = "<button class='mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv1 addedBus trackerPrim1' id=" +
                                  realid + ">" +
                                  text + " - " + stpnm + " (" + direction + ")" +
                                  "</button>";
                    $("#buttons").append(button);
                    $("#" + realid).click(function() {
                      $("#results").empty();
                      var id = this.id;
                      var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
                      var apiEndpoint = "http://www.ctabustracker.com/bustime/api/v2/getpredictions";
                      $.ajax({
                        url: apiPassThruUrl,
                        dataType: "json",
                        method: 'GET',
                        data: {
                          "apiEndpoint": apiEndpoint,
                          "key": "YubEefJ33AeRRyxbmYBbgN2QH",
                          "format": "json",
                          "stpid": id
                        }
                      }).done(function(data) {
                        console.log(data);
                        if (data["bustime-response"]["error"] !== undefined) {
                          $("#results").append("Sorry, no information was found. There may be no buses scheduled in the near future for this route. CTA's fault, not mine.");
                        } else {
                          $("#results").append("<h4>Bus Predictions</h4>" + "<p class='boldText'> Stop name: " + data["bustime-response"]["prd"][0].stpnm + "</p>" +
                            "<p class='boldText'>Route direction: " + data["bustime-response"]["prd"][0].rtdir + "</p>" + "<hr class='blueHr'>");
                          $.each(data["bustime-response"]["prd"], function(index, value) {
                            var prediction = value.prdctdn;
                            if (prediction !== "DLY" && prediction !== "DUE") {
                              minuteString = " MINUTES";
                              var predictionNum = prediction.toString();
                              var prediction = prediction.concat(minuteString);
                            }
                            var html = "<h6 class='boldText'>" + "Bus Arrival Time: " + prediction + "<h6>" +
                              "<hr>";
                            $("#results").append(html);
                          });
                        }
                      });
                    });
                  })
                })
              })
            });
          }
        })
      });
    });
    db.stops.each(function(stops, value) {
      var stopid1 = stops.name;
      var rtnm1 = stops.rtnm;
      var name1 = stops.stopid;
      var rtdir = stops.rtdir;
      var html4 = "<button class='mdl-button mdl-js-button mdl-button--raised mdl-button--colored raisedMargin centeredDiv1 addedBus' id=" +
        stopid1 + ">" +
        rtnm1 + " - " + name1 + " (" + rtdir + ")" +
        "</button>";
      $("#buttons").append(html4);
      $("#" + stopid1).click(function() {
        $("#results").empty();
        var id = this.id;
        var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
        var apiEndpoint = "http://www.ctabustracker.com/bustime/api/v2/getpredictions";
        $.ajax({
          url: apiPassThruUrl,
          dataType: "json",
          method: 'GET',
          data: {
            "apiEndpoint": apiEndpoint,
            "key": "YubEefJ33AeRRyxbmYBbgN2QH",
            "format": "json",
            "stpid": id
          }
        }).done(function(data) {
          console.log(data);
          if (data["bustime-response"]["error"] !== undefined) {
            $("#results").append("Sorry, no information was found. There may be no buses scheduled in the near future for this route. CTA's fault, not mine.");
          } else {
            $("#results").append("<h4>Bus Predictions</h4>" + "<p class='boldText'> Stop name: " + data["bustime-response"]["prd"][0].stpnm + "</p>" +
              "<p class='boldText'>Route direction: " + data["bustime-response"]["prd"][0].rtdir + "</p>" + "<hr class='blueHr'>");
            $.each(data["bustime-response"]["prd"], function(index, value) {
              var prediction = value.prdctdn;
              if (prediction !== "DLY" && prediction !== "DUE") {
                minuteString = " MINUTES";
                var predictionNum = prediction.toString();
                var prediction = prediction.concat(minuteString);
              }
              var html = "<h6 class='boldText'>" + "Bus Arrival Time: " + prediction + "<h6>" +
                "<hr>";
              $("#results").append(html);
            });
          }
        });
      });
    }).catch("NotFoundError", function(error) {
      console.error(error);
    });
    $(".trackerPrim").click(function() {
      $("#results").empty();
      var id = this.id;
      console.log(id);
      $(function() {
        var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
        var apiEndpoint = "http://www.ctabustracker.com/bustime/api/v2/getpredictions";
        $.ajax({
          url: apiPassThruUrl,
          dataType: "json",
          method: 'GET',
          data: {
            "apiEndpoint": apiEndpoint,
            "key": "YubEefJ33AeRRyxbmYBbgN2QH",
            "format": "json",
            "stpid": id
          }
        }).done(function(data) {
          console.log(data);
          if (data["bustime-response"]["error"] !== undefined) {
            $("#results").append("Sorry, no information was found. There may be no buses scheduled in the near future for this route. CTA's fault, not mine.");
          } else {
            $("#results").append("<h4>Bus Predictions</h4>" + "<p class='boldText'> Stop name: " + data["bustime-response"]["prd"][0].stpnm + "</p>" +
              "<p class='boldText'>Route direction: " + data["bustime-response"]["prd"][0].rtdir + "</p>" + "<hr class='blueHr'>");
            $.each(data["bustime-response"]["prd"], function(index, value) {
              var prediction = value.prdctdn;
              if (prediction !== "DLY" && prediction !== "DUE") {
                minuteString = " MINUTES";
                var predictionNum = prediction.toString();
                var prediction = prediction.concat(minuteString);
              }
              var html = "<h6 class='boldText'>" + "Bus Arrival Time: " + prediction + "<h6>" +
                "<hr>";
              $("#results").append(html);
            });
          }
        });
      });
    });
    $(".trackerPrim1").click(function() {
      $("#results").empty();
      var id = this.id;
      $(function() {
        var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
        var apiEndpoint = "http://www.ctabustracker.com/bustime/api/v2/getpredictions";
        $.ajax({
          url: apiPassThruUrl,
          dataType: "json",
          method: 'GET',
          data: {
            "apiEndpoint": apiEndpoint,
            "key": "YubEefJ33AeRRyxbmYBbgN2QH",
            "format": "json",
            "stpid": id
          }
        }).done(function(data) {
          console.log(data);
          if (data["bustime-response"]["error"] !== undefined) {
            $("#results").append("Sorry, no information was found. There may be no buses scheduled in the near future for this route. CTA's fault, not mine.");
          } else {
            $("#results").append("<h4>Bus Predictions</h4>" + "<p class='boldText'> Stop name: " + data["bustime-response"]["prd"][0].stpnm + "</p>" +
              "<p class='boldText'>Route direction: " + data["bustime-response"]["prd"][0].rtdir + "</p>" + "<hr class='blueHr'>");
            $.each(data["bustime-response"]["prd"], function(index, value) {
              var prediction = value.prdctdn;
              if (prediction !== "DLY" && prediction !== "DUE") {
                minuteString = " MINUTES";
                var predictionNum = prediction.toString();
                var prediction = prediction.concat(minuteString);
              }
              var html = "<h6 class='boldText'>" + "Bus Arrival Time: " + prediction + "<h6>" +
                "<hr>";
              $("#results").append(html);
            });
          }
        });
      });
    });
    </script>
</body>
</html>