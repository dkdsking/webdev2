<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CTA BUS TRACKER API</title>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Mada" rel="stylesheet">
  <style>
    body {
      font-family: "Mada", sans-serif;
      background-color: #03A9F4;
    }
    #trackerMenu {
      
    }
    #resultsDiv {
      border: 5px solid #1976D2;
      
      margin-top: 5px;
      padding: 5px;
      width: 25%;
    }
  </style>
</head>
<body>
  <h1>CTA BUS TRACKER</h1>
  <p>Select one of the bus routes below to get it's bus tracker predictions.<br>This app uses real-time data, 
  so <strong>click the button again</strong> to refresh the page.</p>
  

  
  <select id="trackerMenu">
    <option value = 8147>49 + X49 Western and Addison (Northbound)</option>
    <option value = 8195>49 + X49 Western and Addison (Southbound)</option>
    <option value = 12527>152 Addison and Western (Eastbound)</option>
    <option value = 12569>152 Addison and Western (Westbound)</option>
  </select>
  
  <button id="getPredictions">Get the CTA predictions</button>
  
  <div id="resultsHeader"></div>
  <div id="results"></div>
      
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script>
        $("#getPredictions").click(function() {
          $("#resultsHeader").empty()
          $("#results").empty();
          $(function() {
            
            
            var apiPassThruUrl = "https://polar-garden-75406.herokuapp.com/apiPassThru.php";
            
            var apiEndpoint = "http://www.ctabustracker.com/bustime/api/v2/getpredictions";
            
            var stpID = $("#trackerMenu").val();
            
            $.ajax({
                url: apiPassThruUrl,
                dataType: "json",
                method: 'GET',
                data: {"apiEndpoint": apiEndpoint,
                        "key" : "YubEefJ33AeRRyxbmYBbgN2QH",
                        "format":"json",
                        "stpid": stpID}
              }).done (function (data) {
                console.log(data);
                $("#resultsHeader").append("<h1>Bus Predictions</h1>");
               
                $.each (data["bustime-response"]["prd"], function(index,value) {
                    var prediction = value.prdctdn;
                    if (prediction !== "DLY" && prediction !=="DUE" ) {
                      minuteString = " minutes";
                      var predictionNum = prediction.toString();
                      var prediction = prediction.concat(minuteString);
                    }
                    if (prediction == "DLY") {
                      var prediction = "DELAYED";
                    }
                    var delayIf = value.dly;
                    if (delayIf == true) {
                      var delayIf = "YEAH THERE IS SORRY"
                    } else {
                      var delayIf = "NOPE"
                    }
                    var html = "<div id='resultsDiv'>" + "<p>Stop name: " + value.stpnm + "</p>" + "<p>Bus arrival time: " + prediction + " </p>" + 
                    "<p>Route direction: " + value.rtdir + "</p>" + "<p> Delay: " + delayIf + "</p>" + "</div>";
                    
                    $("#results").append(html);
                })
    
                if ($('#results').contents().length == 0) {
                      $("#results").append("Sorry, no information was found for that stop ID. Click the link above if you want to look through the valid IDs.")
                }
  
              });
          });
        });    
  
</script>
 
</body>
</html>